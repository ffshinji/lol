<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFLegendsHub | Liderlik Tablosu</title>
    <link rel="stylesheet" href="css/main.css">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="dashboard.html" class="logo">
                    <img src="https://i.hizliresim.com/h701fas.jpg" class="logo-icon" alt="FF">
                    <span class="logo-text">FFLegendsHub</span>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Ana Men√º</div>
                    <a href="index.html" class="nav-link"><span class="nav-emoji">üìä</span><span>√ñnizleme</span></a>
                    <a href="players.html" class="nav-link"><span class="nav-emoji">üë•</span><span>Oyuncular</span></a>
                    <a href="matches.html" class="nav-link"><span class="nav-emoji">üìú</span><span>Ge√ßmi≈ü
                            Ma√ßlar</span></a>
                    <a href="draft.html" class="nav-link"><span class="nav-emoji">‚öîÔ∏è</span><span>Draft Yap</span></a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">ƒ∞statistikler</div>
                    <a href="leaderboard.html" class="nav-link active"><span class="nav-emoji">üèÜ</span><span>Liderlik
                            Tablosu</span></a>
                    <a href="champions.html" class="nav-link"><span
                            class="nav-emoji">‚≠ê</span><span>≈ûampiyonlar</span></a>
                    <a href="seasons.html" class="nav-link"><span class="nav-emoji">üìÖ</span><span>Sezonlar</span></a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Sistem</div>
                    <a href="settings.html" class="nav-link"><span class="nav-emoji">‚öôÔ∏è</span><span>Ayarlar</span></a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">üèÜ Liderlik Tablosu</h1>
                <p class="page-description">Oyuncularƒ±n performans sƒ±ralamasƒ±.</p>
            </div>


            <div class="card">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width:60px; color: #ff8c00; cursor: pointer;" class="text-center sortable"
                                    onclick="loadLeaderboard('rank')">Sƒ±ra <span id="sort-rank"></span></th>
                                <th style="width: 25%; color: #ff8c00; cursor: pointer;" class="sortable"
                                    onclick="loadLeaderboard('player')">Oyuncu <span id="sort-player"></span></th>
                                <th style="width:140px; text-align: left; padding-left: 20px; color: #ff8c00; cursor: pointer;"
                                    class="sortable" onclick="loadLeaderboard('role')">Rol <span id="sort-role"></span>
                                </th>
                                <th class="text-center sortable" style="color: #ff8c00; cursor: pointer;"
                                    onclick="loadLeaderboard('matches')">Ma√ß <span id="sort-matches"></span></th>
                                <th class="text-center sortable" style="color: #ff8c00; cursor: pointer;"
                                    onclick="loadLeaderboard('wl')">W/L <span id="sort-wl"></span></th>
                                <th class="text-center sortable" style="color: #ff8c00; cursor: pointer;"
                                    onclick="loadLeaderboard('winRate')">Win Rate <span id="sort-winRate"></span></th>
                                <th class="text-center sortable" style="color: #ff8c00; cursor: pointer;"
                                    onclick="loadLeaderboard('kda')">KDA <span id="sort-kda"></span></th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-tbody">
                            <tr>
                                <td colspan="7" class="empty-state">Veri yok.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/db.js"></script>
    <script src="js/stats.js"></script>
    <script src="js/app.js"></script>
    <script>
        let currentSort = { field: 'winRate', direction: 'desc' };

        window.addEventListener('appReady', () => loadLeaderboard('winRate'));
        if (typeof App !== 'undefined' && App.isReady) loadLeaderboard('winRate');

        function loadLeaderboard(sortField = null) {
            // Update sort state
            if (sortField) {
                if (currentSort.field === sortField) {
                    currentSort.direction = currentSort.direction === 'desc' ? 'asc' : 'desc';
                } else {
                    currentSort.field = sortField;
                    currentSort.direction = sortField === 'rank' || sortField === 'player' || sortField === 'role' ? 'asc' : 'desc';
                }
            }

            // Update Sort Icons
            const fields = ['rank', 'player', 'role', 'matches', 'wl', 'winRate', 'kda'];
            fields.forEach(f => {
                const el = document.getElementById(`sort-${f}`);
                if (el) el.textContent = '';
                if (f === currentSort.field) {
                    if (el) el.textContent = currentSort.direction === 'desc' ? '‚ñº' : '‚ñ≤';
                }
            });

            const tbody = document.getElementById('leaderboard-tbody');
            // Fetch ALL stats, unsorted initially
            let leaderboard = Stats.getAllPlayerStats('winRate', 1);

            if (leaderboard.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Hen√ºz oyuncu yok.</td></tr>';
                return;
            }

            // Apply Sort
            leaderboard.sort((a, b) => {
                let valA, valB;
                switch (currentSort.field) {
                    case 'rank':
                        // Fallback to WinRatio sort order for "natural" rank if we aren't storing persistent rank
                        // Actually, "Rank" in the table is just the index 1..N.
                        // If user clicks "Sƒ±ra", they probably want to revert to the "Default" sort (Win Rate).
                        // Let's treat 'rank' as 'winRate' for underlying value, but with explicit reset intent
                        valA = a.winRate; valB = b.winRate;
                        // Tie breaker mostly handled by default logic, but let's be safe
                        if (valA === valB) return b.totalMatches - a.totalMatches;
                        return b.winRate - a.winRate; // Always descending WinRate = Ascending Rank #1, #2...
                    case 'player':
                        valA = (a.player.nickname || a.player.name).toLowerCase();
                        valB = (b.player.nickname || b.player.name).toLowerCase();
                        return currentSort.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    case 'role':
                        valA = Stats.getMainRole(a.player); valB = Stats.getMainRole(b.player);
                        return currentSort.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    case 'matches':
                        valA = a.totalMatches; valB = b.totalMatches; break;
                    case 'wl':
                        valA = a.wins - a.losses; valB = b.wins - b.losses; break;
                    case 'kda':
                        valA = parseFloat(a.kda); valB = parseFloat(b.kda); break;
                    case 'winRate':
                    default:
                        valA = a.winRate; valB = b.winRate; break;
                }
                // Specialized comparisons handled above for strings; numeric down here
                if (typeof valA === 'number') {
                    return currentSort.direction === 'desc' ? valB - valA : valA - valB;
                }
                return 0; // String cases returned earlier
            });

            // Special Case: If sorting by Rank, we want to force standard WinRate Descending order as that Defines rank
            if (currentSort.field === 'rank') {
                leaderboard = Stats.getAllPlayerStats('winRate', 1); // Reset to standard
                if (currentSort.direction === 'desc') {
                    leaderboard.reverse(); // Worst players first if someone wants that?
                }
            }


            tbody.innerHTML = leaderboard.map((s, i) => {
                const player = s.player;
                const role = Stats.getMainRole(player);
                const roleIcon = Utils.getRoleIcon(role);
                const roleName = Utils.getRoleName(role);

                let rankClass = 'normal';
                if (i === 0) rankClass = 'gold';
                else if (i === 1) rankClass = 'silver';
                else if (i === 2) rankClass = 'bronze';

                return `
                    <tr>
                        <td class="text-center"><div class="player-rank ${rankClass}">#${i + 1}</div></td>
                        <td>
                            <div class="flex items-center gap-3" onclick="window.location.href='players.html?id=${player.id}'" style="cursor:pointer; transition:opacity 0.2s" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                                ${Utils.renderAvatarHtml(player)}
                                <span class="player-name">${Utils.escapeHtml(player.nickname || player.name)}</span>
                            </div>
                        </td>
                        <td style="text-align: left; padding-left: 20px;">
                             <div class="flex items-center gap-2" title="${roleName}">
                                  <img src="${roleIcon}" style="width: 20px; height: 20px; opacity: 1;">
                                  <span style="font-size: var(--text-xs); color: var(--text-muted); font-weight: 500;">${roleName}</span>
                             </div>
                        </td>
                        <td class="text-center">${s.totalMatches}</td>
                        <td class="text-center"><span class="text-win">${s.wins}</span>/<span class="text-lose">${s.losses}</span></td>
                        <td class="text-center" style="${Utils.getWinRateColor(s.winRate)}; font-weight:bold">${s.winRate}%</td>
                        <td class="text-center" style="${Utils.getKDAColor(s.kda)}; font-weight:bold">${s.kda}</td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>

</html>